<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>GartenIS - Virtueller Rundgang Herrenhäuser Gärten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --gap:16px; --accent:#0b3a66; --btn-blue:#0d6efd; }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:#f4f6f8;color:#222;}
    header{display:flex;align-items:center;gap:12px;padding:18px;background:linear-gradient(180deg,var(--accent),#0d4771);color:#fff;}
    header h1{margin:0;font-size:20px;flex:1;text-shadow:0 1px 0 rgba(0,0,0,0.15);}
    .visit-link{color:#fff;text-decoration:none;background:rgba(255,255,255,0.08);padding:8px 12px;border-radius:8px;font-weight:600;}
    .visit-link:hover{background:rgba(255,255,255,0.14);}
    main{max-width:1100px;margin:20px auto;padding:0 16px 40px;display:flex;flex-direction:column;gap:var(--gap);}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(16,24,40,0.06);}
    .intro strong{display:block;margin-bottom:8px;color:var(--accent);font-size:15px;}
    .intro p{margin:0 0 10px 0;color:#444;line-height:1.45;}
    .cam-header{display:flex;justify-content:center;align-items:center;gap:12px;}
    .cam-header h2{margin:0;color:var(--accent);font-size:16px;text-align:center;}
    #viewWindow{width:100%;height:56vw;max-height:68vh;min-height:300px;background:#000;border-radius:10px;overflow:hidden;position:relative;}
    @media (max-width:900px){#viewWindow{height:55vh;}}
    #videoElement{position:absolute;width:100%;height:100%;object-fit:cover;top:0;left:0;z-index:0;background:#000;}
    #webgl-output{position:absolute;width:100%;height:100%;top:0;left:0;z-index:1;pointer-events:auto;}
    #infoBox{position:absolute;top:12px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.96);color:#111;padding:8px 12px;border-radius:8px;display:none;z-index:6;font-weight:600;font-size:14px;cursor:pointer;}
    .controls-row{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px;}
    button{cursor:pointer;border:0;padding:8px 12px;border-radius:8px;font-weight:600;}
    .btn-primary{background:var(--btn-blue);color:#fff;}
    .btn-secondary{background:#eef2f6;color:var(--accent);}
    section.stations{margin-top:4px;}
    section.stations h3{margin:0 0 8px 0;color:var(--accent);}
    .stations-text{color:#444;margin-top:6px;}
    #mapStations{width:100%;height:420px;border-radius:8px;overflow:hidden;margin-top:12px;}
    .map-controls{display:flex;gap:8px;align-items:center;margin-top:8px;}
    #locateBtn{background:var(--btn-blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;}
    footer{margin-top:18px;text-align:center;color:#666;font-size:13px;}
    .muted{color:#666;font-size:13px;}
    .user-arrow { transform-origin:center; }

    /* AR iframe overlay */
    #arOverlay {
      position:fixed;
      inset:0;
      display:none;
      z-index:9999;
      background:rgba(0,0,0,0.9);
      align-items:flex-start;
      justify-content:center;
      padding:8px;
    }
    #arIframe {
      width:100%;
      height:100%;
      border:0;
      border-radius:0;
      background:#000;
    }
    #arCloseBtn {
      position: absolute;
      right: 14px;
      top: 14px;
      z-index:10000;
      background:rgba(255,255,255,0.95);
      color:#0d4771;
      border-radius:8px;
      padding:10px 12px;
      font-weight:700;
      box-shadow:0 6px 14px rgba(0,0,0,0.25);
      cursor:pointer;
    }

    /* Smooth hide animation */
    .hidden-ui { display:none !important; }
  </style>
</head>
<body>
  <header id="mainHeader">
    <h1>GartenIS - Virtueller Rundgang Herrenhäuser Gärten</h1>
    <a class="visit-link" href="https://herrenhaeuser-gaerten.hannover.de/Herrenhausen-erleben" target="_blank">Herrenhäuser Gärten Hannover</a>
  </header>

  <main id="mainContent">
    <div class="card intro" id="introCard">
      <strong>Kurzinfo</strong>
      <p>
        Die AR‑Anwendung bietet einen interaktiven, virtuellen Rundgang durch die Herrenhäuser Gärten. Besucherinnen und Besucher können über das Kamerafenster Würfel‑Stationen in ihrer Umgebung platzieren, zu jedem gesetzten Punkt weiterführende Informationen abrufen und so historische Hintergründe, besondere Pflanzen und gestalterische Details der Anlage kompakt erleben.
      </p>
      <p>
        Die Anwendung kombiniert visuelle Modelle, erklärende Texte und Links und ergänzt damit die reale Besichtigung durch zusätzliche Kontextinformationen zu Brunnen, Beeten und Gartenarchitektur.
      </p>
    </div>

    <div class="card" id="cameraCard">
      <div class="cam-header">
        <h2>Experience Herrenhausen Gardens in Hanover virtually!</h2>
      </div>

      <div id="viewWindow">
        <video id="videoElement" autoplay playsinline muted></video>
        <div id="webgl-output"></div>
        <div id="infoBox">Mehr Informationen zu dieser Station</div>
      </div>

      <div class="controls-row" style="margin-top:12px;" id="controlsRow">
        <div style="margin-right:auto;color:#666;">Tippe auf "Start AR" für echtes Platzieren; Vorschau erlaubt erstes Testen.</div>
        <button id="placePreviewBtn" class="btn-secondary">Platzieren (Vorschau)</button>
        <button id="togglePreviewBtn" class="btn-secondary">Vorschau umschalten</button>
        <button id="startARBtn" class="btn-primary">Start AR</button>
        <button id="undoBtn" class="btn-secondary" style="display:none">Undo</button>
      </div>
    </div>

    <section class="card stations" id="stationsCard">
      <h3>Stationen des virtuellen Rundgangs</h3>
      <p class="stations-text">
        Die Karte unten zeigt Ihre aktuelle Position sowie die Stationen des virtuellen Rundgangs zur Orientierung in den Herrenhäuser Gärten. Tippen Sie im Kamerafenster, um in der Vorschau Würfel zu setzen, oder starten Sie AR für Platzierungen in der realen Umgebung.
      </p>

      <div id="mapStations"></div>
      <div class="map-controls">
        <button id="locateBtn">Meine Position</button>
        <div style="color:#666;font-size:13px;">Erlaube Standortzugriff, damit deine Position und die Stationen korrekt angezeigt werden.</div>
      </div>
    </section>

    <footer id="mainFooter">© Lars Niehsen - not for private or commercial use allowed! </footer>
  </main>

  <!-- AR overlay (iframe) -->
  <div id="arOverlay">
    <button id="arCloseBtn" title="AR beenden">Beenden</button>
    <iframe id="arIframe" src="" allow="camera; fullscreen; xr-spatial-tracking"></iframe>
  </div>

  <script>
    // Replace previous tab-opening behavior: load HitTest.html into iframe and hide UI.
    (function() {
      const startBtn = document.getElementById('startARBtn');
      const arOverlay = document.getElementById('arOverlay');
      const arIframe = document.getElementById('arIframe');
      const closeBtn = document.getElementById('arCloseBtn');

      const uiToHide = [
        document.getElementById('mainHeader'),
        document.getElementById('introCard'),
        document.getElementById('cameraCard'),
        document.getElementById('stationsCard'),
        document.getElementById('mainFooter'),
        document.getElementById('controlsRow')
      ];

      function hideUI() {
        uiToHide.forEach(el => { if (el) el.classList.add('hidden-ui'); });
      }
      function showUI() {
        uiToHide.forEach(el => { if (el) el.classList.remove('hidden-ui'); });
      }

      startBtn.addEventListener('click', (ev) => {
        // open overlay immediately — this is a synchronous user action
        hideUI();
        arOverlay.style.display = 'flex';

        // load AR page inside iframe (path relative to index.html)
        // Ensure HitTest.html is reachable and served over HTTPS
        arIframe.src = 'HitTest.html';

        // Optional: focus iframe to bring it visually forward on some devices
        arIframe.focus();
      });

      // Close AR and restore UI
      closeBtn.addEventListener('click', () => {
        // attempt to stop any camera / scripts inside iframe by navigating to about:blank
        try { arIframe.src = 'about:blank'; } catch(e) { /* ignore */ }
        arOverlay.style.display = 'none';
        showUI();
      });

      // If the iframe wants to signal closing, it can postMessage to parent:
      window.addEventListener('message', (ev) => {
        // Basic safety: only accept messages from same origin
        try {
          if (ev.origin !== window.location.origin) return;
        } catch(e) { /* origin access may throw on some browsers; ignore */ }

        if (ev.data === 'exit-ar') {
          closeBtn.click();
        }
      });
    })();
  </script>

  <!-- lightweight preview placement script (keeps UI behavior, no WebXR here) -->
  <script>
    (function () {
      const view = document.getElementById('viewWindow');
      const previewBtn = document.getElementById('placePreviewBtn');
      const toggleBtn = document.getElementById('togglePreviewBtn');
      const undoBtn = document.getElementById('undoBtn');
      const infoBox = document.getElementById('infoBox');

      let previewEnabled = true;
      let previewMarkers = [];

      toggleBtn.addEventListener('click', () => {
        previewEnabled = !previewEnabled;
        toggleBtn.textContent = previewEnabled ? 'Vorschau umschalten' : 'Vorschau umschalten';
        view.style.filter = previewEnabled ? 'none' : 'grayscale(30%)';
      });

      previewBtn.addEventListener('click', () => {
        if (!previewEnabled) return;
        placePreviewMarker({ x: Math.random() * (view.clientWidth - 80) + 40, y: Math.random() * (view.clientHeight - 80) + 40 });
      });

      function placePreviewMarker(pos) {
        const el = document.createElement('div');
        el.style.position = 'absolute';
        el.style.width = '48px';
        el.style.height = '48px';
        el.style.left = pos.x + 'px';
        el.style.top = pos.y + 'px';
        el.style.transform = 'translate(-50%,-50%)';
        el.style.background = 'rgba(13,110,253,0.9)';
        el.style.borderRadius = '8px';
        el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
        el.style.zIndex = 5;
        el.style.cursor = 'pointer';
        el.title = 'Vorschau-Station (Tippe für Info)';

        el.addEventListener('click', (e) => {
          e.stopPropagation();
          infoBox.style.display = 'block';
          infoBox.textContent = 'Vorschau-Station: Weitere Informationen öffnen AR-Ansicht.';
        });

        document.getElementById('viewWindow').appendChild(el);
        previewMarkers.push(el);
        undoBtn.style.display = 'inline-block';
      }

      undoBtn.addEventListener('click', () => {
        const last = previewMarkers.pop();
        if (last && last.parentNode) last.parentNode.removeChild(last);
        if (previewMarkers.length === 0) undoBtn.style.display = 'none';
      });

      // Hide infoBox on click anywhere else
      document.addEventListener('click', (ev) => {
        if (!ev.target.closest('#viewWindow')) {
          infoBox.style.display = 'none';
        }
      });
    })();
  </script>

  <!-- external libs retained for map and potential 3D preview usage -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- minimal map initialization to keep original functionality -->
  <script>
    (function () {
      const mapEl = document.getElementById('mapStations');
      if (!mapEl) return;

      try {
        const map = L.map(mapEl).setView([52.374, 9.716], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // example station markers (replace with your real station data)
        const stations = [
          { title: 'Großer Garten', coords: [52.3745, 9.7155] },
          { title: 'Berggarten', coords: [52.3751, 9.7172] }
        ];

        stations.forEach(s => {
          L.marker(s.coords).addTo(map).bindPopup(`<strong>${s.title}</strong>`);
        });

        // locate button
        document.getElementById('locateBtn').addEventListener('click', () => {
          map.locate({ setView: true, maxZoom: 17 });
        });

        map.on('locationfound', (e) => {
          L.circle(e.latlng, { radius: e.accuracy / 2, color: '#0d6efd' }).addTo(map);
        });
      } catch (err) {
        console.warn('Leaflet init failed', err);
      }
    })();
  </script>
</body>
</html>
